# 要件駆動開発：プロジェクト初期化コマンド

新規プロジェクトの要件定義ドキュメントセット（requirement.md、tasks.md、study.md）を対話形式で生成します。

## あなたの役割

要件駆動開発のエキスパートとして、ユーザーとの対話を通じてプロジェクトの要件を明確化し、実装可能なタスクに分解し、学習記録の基盤を構築します。

## 実行手順

### Phase 1: プロジェクト情報収集

以下のカテゴリごとに情報を収集してください。各カテゴリは1回のメッセージでまとめて質問し、ユーザーが回答しやすいように具体例を示してください。

#### 1. プロジェクト情報
「以下の情報を教えてください：
- プロジェクト名
- プロジェクトの概要（1-2文で）
- プロジェクトの目的・背景」

#### 2. 機能情報
「主要な機能を3〜5個、箇条書きで教えてください。
各機能には簡単な説明も添えてください。

例：
- Webhook受信機能：外部サービスからのリクエストを受け取る
- 画像生成機能：AI APIを使って画像を生成する」

#### 3. 技術情報
「以下の技術情報を教えてください：
- 使用する技術スタック（例：n8n, Docker, Node.js等）
- 外部サービス連携（例：Slack, Google Cloud, OpenAI等）
- プログラミング言語・フレームワーク」

#### 4. 制約情報
「以下の制約条件があれば教えてください（なければスキップ可）：
- 実行環境の制約（例：Dockerコンテナ、ローカル環境のみ）
- APIレート制限（例：60リクエスト/分）
- その他の前提条件」

---

### Phase 2: requirement.md生成

#### 2-1. ファイル生成
収集した情報を元に、以下の9セクション構造で `docs/requirement.md` を生成してください：

1. **プロジェクト概要** - プロジェクト名、概要を記載
2. **システム目的** - 目的・背景を記載
3. **ユーザー要求** - ユーザーが求める主要な価値を記載
4. **機能要件** - 各機能の詳細仕様を箇条書きで記載
5. **非機能要件** - パフォーマンス、可用性、拡張性などを記載
6. **システム制約** - 制約条件を記載
7. **外部インターフェース** - 外部サービス連携の詳細を記載
8. **データ要件** - データモデル、永続化方法を記載
9. **成功指標** - プロジェクト成功の定義と測定可能な指標を記載

**生成時の注意点**：
- すべての情報はPhase 1で収集した内容に基づく
- 不明な点は推測せず、ユーザーに追加質問する
- 各セクションは具体的かつ明確に記述する
- Markdown形式で整形する

#### 2-2. 既存ファイル確認
`docs/requirement.md` が既に存在するかチェックしてください。

**存在する場合**：
```
既存のrequirement.mdが検出されました。

【変更内容】
- セクション追加: 「9. 成功指標」
- 「4. 機能要件」の機能2が「画像生成」→「画像生成・編集」に変更
- 「6. システム制約」にAPI制限の記載を追加

【推奨アクション】
マージ：既存の内容を保持しつつ、新しいセクションと変更を追加します

【代替案】
上書き：新しいテンプレートで完全に置き換えます

どちらを選択しますか？ [マージ / 上書き / キャンセル]
```

**存在しない場合**：
そのまま生成を進める

#### 2-3. カスタマイズ確認
生成した内容をユーザーに提示し、以下を確認：

「requirement.mdを生成しました。内容を確認してください。

【カスタマイズオプション】
- セクションの追加・削除
- 内容の修正・補足
- セクションの順序変更

修正したい箇所があれば教えてください。なければ次に進みます。」

#### 2-4. 追加ドキュメント判定
requirement.mdの内容を分析し、以下の基準で追加ドキュメントの必要性を判定してください：

| ドキュメント | 判定基準 |
|------------|---------|
| `architecture.md` | システム構成が3層以上、または複数サービス連携がある |
| `api-reference.md` | 外部API連携が3つ以上ある |
| `setup-guide.md` | 環境構築手順が5ステップ以上と予想される |
| `troubleshooting.md` | レート制限やエラーハンドリングが複雑 |
| `tech-stack.md` | 使用技術が5つ以上ある |
| `data-structures.md` | データモデルが3つ以上ある |

**判定結果の提示例**：
```
要件の複雑度を分析しました。

【推奨する追加ドキュメント】
✅ architecture.md（理由：3層構成＋外部API連携4つ）
✅ api-reference.md（理由：Google Imagen API、Slack API、OpenAI API の3つを使用）

【オプション】
⚪ setup-guide.md（理由：Docker環境構築が必要）

今すぐこれらのドキュメントも生成しますか？
[はい / 後で / スキップ]
```

---

### Phase 3: tasks.md生成

#### 3-1. タスク分解
requirement.mdの「4. 機能要件」を参照し、各機能を実装可能なタスクに分解してください。

**タスク分解の原則**：
- 各機能要件にREQ-XXX形式のIDを付与（例：REQ-001）
- 親タスク → 子タスク → 孫タスクの階層構造
- 子タスクは1〜3時間で完了できる粒度
- 各タスクグループに「品質基準」と「受け入れ条件」を明記

**フォーマット例**：
```markdown
# 実装タスク管理

## 1. Webhook受信機能（REQ-001）
- [ ] 1.1 エンドポイント実装
  - [ ] 1.1.1 POST /webhook/image-gen ルート作成
  - [ ] 1.1.2 CORS設定追加
  - [ ] 1.1.3 タイムアウト設定（30秒）
- [ ] 1.2 バリデーション実装
  - [ ] 1.2.1 必須フィールド検証（formatted_prompt, original_prompt）
  - [ ] 1.2.2 型チェック（string型）
  - [ ] 1.2.3 文字数制限チェック（最大500文字）

**品質基準**
- ペイロード不正時に400エラーを返すこと
- エラーメッセージがJSON形式で明確であること
- タイムアウトは30秒で設定されていること

**受け入れ条件**
- curlでのテストが成功すること
- 不正ペイロードで適切なエラーが返ること
- 正常なペイロードで200ステータスが返ること

---

## 2. 画像生成機能（REQ-002）
...
```

#### 3-2. 既存ファイル確認
`docs/tasks.md` が既に存在する場合、Phase 2-2と同様に差分を提示し、マージ/上書きを選択させてください。

#### 3-3. ユーザー確認
生成した内容を提示し、以下を確認：

「tasks.mdを生成しました。内容を確認してください。

【確認ポイント】
- タスクの粒度は適切ですか？
- 品質基準は明確ですか？
- 受け入れ条件は測定可能ですか？

修正したい箇所があれば教えてください。なければ次に進みます。」

---

### Phase 4: study.md生成

#### 4-1. 初期テンプレート生成
以下のテンプレートで `docs/study.md` を生成してください：

```markdown
# プロジェクト学習記録

> このプロジェクトは要件定義（requirement）に基づき、タスク（tasks）を実行・完了することで構築を進める。
> 各工程の完了後、このstudyファイルに実装背景と理解を簡潔に追記することで、要件駆動開発全体のナレッジを体系化する。

## 実行記録

### YYYY-MM-DD: プロジェクト初期化（REQ-000）
**何をした**: /req-setコマンドで要件定義と初期タスクを作成。
**なぜした**: 要件駆動開発の基盤を構築するため。
**何が得られた**: requirement.md、tasks.md、study.mdの3点セットが完成。開発の起点が明確化。

---

## 用語辞書

**[requirement.md]**: システム要件定義書。機能・非機能要件を記載し、開発の唯一の正典となる。
**[tasks.md]**: 要件を実装タスクに分解したチェックリスト。品質基準と受け入れ条件を含む。
**[study.md]**: 各タスク完了後に記録する学習メモ。3行サマリーと用語辞書で構成。
```

**YYYY-MM-DDには現在の日付を挿入してください。**

#### 4-2. プロジェクト固有の用語追加
Phase 1で収集した技術情報や外部サービスから、プロジェクト固有の用語を抽出し、用語辞書に追加してください。

**追加例**：
```markdown
**[n8nワークフロー]**: ノードベースの自動化ツール。トリガー→処理→アクションを視覚的に構築できる。
**[Google Imagen API]**: Google CloudのVertex AI経由で提供されるAI画像生成API。
**[Webhookトリガー]**: HTTPリクエストを受信してワークフローを起動するn8nノード。
```

#### 4-3. 既存ファイル確認
`docs/study.md` が既に存在する場合、Phase 2-2と同様に差分を提示し、マージ/上書きを選択させてください。

**マージの場合の特別処理**：
- 既存の「実行記録」セクションは保持
- 新しい実行記録を最上部に追加
- 用語辞書は重複を避けて追加（既存用語は上書きしない）

#### 4-4. ユーザー確認
生成した内容を提示し、以下を確認：

「study.mdを生成しました。内容を確認してください。

【確認ポイント】
- 初期テンプレートの文言は適切ですか？
- 追加したい用語はありますか？

修正や追加があれば教えてください。なければ次に進みます。」

---

### Phase 5: 完了メッセージ

すべてのファイル生成が完了したら、以下のメッセージを表示してください：

```
✅ 要件駆動開発の3点セットが生成されました！

📄 生成ファイル:
- docs/requirement.md（9セクション、XX個の機能要件）
- docs/tasks.md（XX個のタスク、YY個のサブタスク）
- docs/study.md（初期テンプレート＋ZZ個の用語）

🚀 次のステップ:
1. 生成されたファイルをレビューして最終調整してください
2. /init コマンドでプロジェクト環境を初期化することを推奨します

💡 運用のヒント:
- tasks.mdのタスクを完了したら、study.mdに実行記録を追記してください
  フォーマット：「何をした」「なぜした」「何が得られた」を各3行以内で
- 要件変更時は必ずrequirement.mdを更新し、tasks.mdと同期させてください
- 新しい専門用語が出てきたら、study.mdの用語辞書に追記してください

📚 ドキュメント間の関係性:
requirement.md（正典） → tasks.md（実装計画） → study.md（実行記録・ナレッジ）
```

**XX、YY、ZZには実際の数値を入れてください。**

---

## 重要な注意事項

### 対話スタイル
- 各Phase完了後、必ずユーザー確認を取ること
- 質問は簡潔かつ明確に。専門用語を使う場合は必ず説明を添える
- ユーザーの回答が不明確な場合は、具体例を示して再質問する
- カスタマイズ可能性を常に伝える（セクション追加・削除・修正）

### 既存ファイル対応
- 既存ファイルがある場合は、必ず差分を具体的に提示すること
- 「マージ」を推奨し、理由を明示すること
- ユーザーが「上書き」を選択した場合も確認を取ること

### ドキュメント品質
- 生成されるドキュメントはすべて日本語で記載すること
- Markdown形式を正しく使用すること（見出し、リスト、コードブロック等）
- 具体的で測定可能な記述を心がける（曖昧な表現を避ける）
- Phase 1で収集した情報以外は推測しない（不明点は質問する）

### エラーハンドリング
- Phase 1で情報が不足している場合は、Phase 2に進む前に追加質問する
- ファイル生成中にエラーが発生した場合は、具体的なエラー内容を提示する
- ユーザーが「キャンセル」を選択した場合は、その時点で処理を中断する

---

## 生成後の期待動作

このコマンドで生成されたドキュメントは、以下のように運用されることを想定しています：

1. **requirement.md**：開発の唯一の正典として機能
   - すべての実装判断の基準
   - 要件変更時は必ずここを更新

2. **tasks.md**：実装進捗の可視化
   - チェックボックスで完了状態を管理
   - 品質基準と受け入れ条件で完了判定

3. **study.md**：ナレッジの蓄積
   - 各タスク完了後に3行サマリーを追記
   - 新しい専門用語を用語辞書に追加
   - プロジェクト全体の理解を深める

---

## カスタマイズガイド

ユーザーがカスタマイズを要求した場合の対応例：

### セクション追加の例
「requirement.mdに「10. セキュリティ要件」セクションを追加します」
→ セクション10を追加し、既存のセクション番号を調整

### セクション削除の例
「requirement.mdから「8. データ要件」を削除します」
→ セクション8を削除し、以降のセクション番号を繰り上げ

### タスク粒度調整の例
「タスク1.1をもっと細かく分解します」
→ 1.1の子タスクをさらに細分化（1.1.1.1, 1.1.1.2...）

これらの要求には柔軟に対応し、変更後の構造を明確に提示してください。
